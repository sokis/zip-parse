"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function znorm(e){return e.replace(/\\/g,"/")}function zjoin(e,t){return znorm(path__default.join(e,t))}function _readFileSync(e,t){var r=this.files[e];if(!r)return fs.readFileSync(e,t);var n=new Buffer(FH_SIZE);this._readSync(n,r.offset);var a=this._getDataOffset(r,n),i=new Buffer(r.csize),s=this._readSync(i,a);assert.equal(s,i.length);var u=void 0;if(0===r.method)u=i;else{if(8!==r.method)throw Error("Unsupported compression method "+r.method);u=zlib.inflateRawSync(i)}return t?u.toString(t):u}function _statSync(e){if(!this.existsSync(e))return fs.existsSync(e);var t=this.files[e];return Object.assign({isDirectory:function(){return t.dir},isFile:function(){return!t.dir}},t)}function _stat(e,t){try{var r=this.statSync(e);t&&t(null,r)}catch(e){t&&t(e)}}function _readFile(e,t,r){var n=this,a=this.files[e];if(!a)return"function"==typeof t&&(r=t,t=null),fs.readFile(e,t,r);var i=new Buffer(FH_SIZE);this._readAsync(i,a.offset,function(){var e=n._getDataOffset(a,i),t=new Buffer(a.csize);n._readAsync(t,e,function(e,n){assert.equal(n,t.length),0===a.method?r(null,t):8===a.method&&zlib.inflateRaw(t,r)})})}function _filter(e){var t=[];for(var r in this.files){var n=this.files[r];e(r,n)&&t.push(n)}return t}function _ref$1(e){return path__default.basename(e.name)}function _readdir(e,t){e=zjoin(e,"/");var r=this.filter(function(t,r){var n=t.indexOf("/",e.length);return 0===t.indexOf(e)&&t!==e&&(-1===n||n==t.length-1)}).map(_ref$1);return t&&t(null,r),r}function _readdirSync(e){return this.readdir(e)}function _realpathSync(e){return zjoin(this.path,e)}function _getDataOffset2(e,t){assert.equal(t.readUIntLE(0,4),FH_SIGN,"Couldn't find file signature");var r=t.readUIntLE(26,2),n=t.readUIntLE(28,2);return e.offset+t.length+r+n}function _readSync2(e,t){return e.length?readSync(this.fd,e,0,e.length,t):0}function _readAsync2(e,t,r){if(e.length)return readAsync(this.fd,e,0,e.length,t,r);r(null,0,e)}function _readCDEntry2(e,t){function r(r,n){return e.readUIntLE(t+r,n)}assert.equal(r(0,4),CDE_SIGN,"Couldn't find CD signature");var n=r(28,2),a=t+CDE_SIZE,i=r(30,2),s=r(32,2),u=e.toString(void 0,a,a+n),f={name:u,method:r(10,2),csize:r(20,4),usize:r(24,4),offset:r(42,4)};return f.dir="/"==u.substr(-1),f.dir&&(this.files[f.name.substr(0,f.name.length-1)]=f),this.files[f.name]=f,CDE_SIZE+n+i+s}function _getCD2(){var e=new Buffer(EOCD_SIZE);this._readSync(e,this.fileLen-e.length),assert.equal(e.readUIntLE(0,4),EOCD_SIGN,"Couldn't find EOCD signature");var t=e.readUIntLE(12,4),r=e.readUIntLE(16,4),n=new Buffer(t),a=this._readSync(n,r);return assert.equal(a,t),{records:e.readUIntLE(10,2),buf:n}}function _loadCD2(){for(var e=this._getCD(),t=0,r=0;r<e.records;r++)t+=this._readCDEntry(e.buf,t)}function _close(){closeSync(this.fd)}function _exists(e){return e in this.files}function _existsSync(e){return this.exists(e)}function getZip(e){e=znorm(e);var t=ZIP_CACHE[e];if(t)return t;var r=new Archive(e);return ZIP_CACHE[e]=r,r}function parseZipPath(e){var t=e.indexOf(".zip");return-1!=t&&{zip:znorm(e.substr(0,t+4)),entry:znorm(e.substr(t+5))}}function hasOwnProperty(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function readPackage(e,t){if(hasOwnProperty(packageMainCache,t))return packageMainCache[t];var r=zjoin(t,"package.json"),n=void 0,a=void 0;try{n=e.readFileSync(r,"utf8")}catch(e){return!1}try{a=packageMainCache[t]=JSON.parse(n).main}catch(e){throw e.path=r,e.message="Error parsing "+r+": "+e.message,e}return a}function tryFile(e,t){try{var r=e.statSync(t);if(r&&!r.isDirectory())return e.realpathSync(t,Module._realpathCache)}catch(e){}return!1}function tryExtensions(e,t,r){for(var n=0;n<r.length;n++){var a=tryFile(e,t+r[n]);if(a)return a}return!1}function tryPackage(e,t,r){var n=readPackage(e,t);if(!n)return!1;var a=zjoin(t,n);return tryFile(e,a)||tryExtensions(e,a,r)||tryExtensions(e,zjoin(a,"index"),r)}function _ref(e){var t=fs[e];fs[e]=function(r,n,a){var i=(r=path.resolve(r)).indexOf(".zip"),s=r.indexOf("package.json");if(-1!==s&&s-5===i&&(i=(r=r.substr(0,i-5)+r.substr(s-1)).indexOf(".zip")),-1==i)return t.apply(fs,arguments);var u=parseZipPath(r);return getZip(u.zip)[e](znorm(u.entry),n,a)}}var fs=_interopDefault(require("fs")),path=require("path"),path__default=_interopDefault(path),Module=_interopDefault(require("module")),assert=_interopDefault(require("assert")),zlib=_interopDefault(require("zlib")),classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),openSync=fs.openSync,closeSync=fs.closeSync,statSync=fs.statSync,readSync=fs.readSync,readAsync=fs.read,FH_SIZE=30,FH_SIGN=67324752,EOCD_SIZE=22,EOCD_SIGN=101010256,CDE_SIZE=46,CDE_SIGN=33639248,Archive=function(){function e(t){classCallCheck(this,e),this.path=t,this.fd=openSync(t,"r"),this.fileLen=statSync(t).size,this.files={},this._loadCD()}return createClass(e,[{key:"readFileSync",value:_readFileSync},{key:"statSync",value:_statSync},{key:"stat",value:_stat},{key:"readFile",value:_readFile},{key:"filter",value:_filter},{key:"readdir",value:_readdir},{key:"readdirSync",value:_readdirSync},{key:"realpathSync",value:_realpathSync},{key:"_getDataOffset",value:_getDataOffset2},{key:"_readSync",value:_readSync2},{key:"_readAsync",value:_readAsync2},{key:"_readCDEntry",value:_readCDEntry2},{key:"_getCD",value:_getCD2},{key:"_loadCD",value:_loadCD2},{key:"close",value:_close},{key:"exists",value:_exists},{key:"existsSync",value:_existsSync}]),e}(),zipParse=function(e){return new Archive(e)},ZIP_CACHE={},packageMainCache={};["readFileSync","readFile","readdirSync","readdir","statSync","stat","realpathSync","existsSync"].forEach(_ref),function(){var e=Module._findPath;Module._findPath=function(t,r){var n=e.apply(module,arguments);if(n)return n;var a=Object.keys(Module._extensions);"/"===t.charAt(0)&&(r=[""]);var i="/"===t.slice(-1),s=JSON.stringify({request:t,paths:r});if(Module._pathCache[s])return Module._pathCache[s];for(var u=0,f=r.length;u<f;u++){var c=parseZipPath(path.resolve(r[u],t));if(c){var o=getZip(c.zip),l=void 0;if(i||(l=tryFile(o,c.entry))||(l=tryExtensions(o,c.entry,a)),l||(l=tryPackage(o,c.entry,a)),l||(l=tryExtensions(o,zjoin(c.entry,"index"),a)),l)return Module._pathCache[s]=l,l}}return!1}}(),module.exports=zipParse;
